<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Services - Task Masters</title>
    <link rel="stylesheet" href="styles.css">
    <script src="location.js"></script>
    <style>
        body.dark-mode { background: #1a1a1a; color: #e0e0e0; }
        body.dark-mode .modern-navbar { background: #0d1117 !important; }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3 { color: #ffffff; }
        body.dark-mode p { color: #b0b0b0; }
        body.dark-mode .service-card { background: #0d1117; border: 1px solid #30363d; }
        body.dark-mode .footer { background: #0d1117; border-top: 1px solid #30363d; }
        body.dark-mode .footer h3, body.dark-mode .footer h4, body.dark-mode .footer p, body.dark-mode .footer a { color: #e0e0e0; }
    </style>
    <script>
        (function() {
            try {
                const custSettings = JSON.parse(localStorage.getItem('customerSettings') || '{}');
                const provSettings = JSON.parse(localStorage.getItem('providerSettings') || '{}');
                if (custSettings.darkMode === true || provSettings.darkMode === true) {
                    document.documentElement.classList.add('dark-mode');
                    document.body.classList.add('dark-mode');
                }
            } catch(e) {}
        })();
    </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="index.html"><h2>üéØ Task Masters</h2></a>
            </div>
            
            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <div class="nav-links" id="navLinks">
                <a href="index.html">Home</a>
                <a href="services-browse.html">Services</a>
                <a href="index.html#how-it-works">How it Works</a>
                <a href="index.html#about">About</a>
                <a href="service-provider-login.html" class="btn-provider" id="providerBtn">Become a Provider</a>
                <button class="btn-login" id="loginBtn" onclick="showCustomerLogin()">Login</button>
            </div>
        </div>
    </nav>

    <!-- Service Header -->
    <section class="service-header">
        <div class="service-header-content">
            <h1 id="serviceTitle">Service Providers</h1>
            <p id="serviceDescription">Browse available professionals in your area</p>
            
            <div class="search-filter-bar">
                <input type="text" id="locationInput" placeholder="Enter your location" readonly style="cursor: default;" title="Click 'Change Location' button to update your location" />
                <select id="sortBy">
                    <option value="rating">Sort by Rating</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="experience">Experience</option>
                </select>
                <button class="btn-filter" onclick="applyFilters()">Apply</button>
            </div>
        </div>
    </section>

    <!-- Providers Section -->
    <section class="providers-section">
        <div class="providers-container">
            <div class="filters-sidebar">
                <h3>Filters</h3>
                
                <div class="filter-group">
                    <h4>Price Range</h4>
                    <p style="color: #666; font-size: 13px; margin-bottom: 15px;">The average nightly price is <strong>$120</strong></p>
                    
                    <!-- Price Range Histogram -->
                    <div id="priceHistogram" style="display: flex; align-items: flex-end; gap: 4px; height: 80px; margin-bottom: 15px; padding: 0 5px;">
                        <!-- Bars will be generated by JavaScript -->
                    </div>
                    
                    <!-- Price Range Slider -->
                    <div style="padding: 0 5px; margin-bottom: 15px;">
                        <div style="position: relative; height: 40px; margin: 20px 0;">
                            <!-- Track background -->
                            <div style="position: absolute; top: 17px; left: 0; right: 0; height: 6px; background: #e0e0e0; border-radius: 3px;"></div>
                            <!-- Active track -->
                            <div id="priceRangeTrack" style="position: absolute; top: 17px; height: 6px; background: #222; border-radius: 3px; left: 0%; right: 0%;"></div>
                            <!-- Min slider -->
                            <input type="range" id="priceMin" min="0" max="500" value="0" step="10" 
                                   style="position: absolute; width: 100%; top: 10px; left: 0; -webkit-appearance: none; appearance: none; background: transparent; pointer-events: all; z-index: 3; cursor: pointer;" 
                                   oninput="updatePriceRange(true)" 
                                   onmousedown="startDragging('min')"
                                   onmouseup="stopDragging()"
                                   ontouchstart="startDragging('min')"
                                   ontouchend="stopDragging()" />
                            <!-- Max slider -->
                            <input type="range" id="priceMax" min="0" max="500" value="500" step="10" 
                                   style="position: absolute; width: 100%; top: 10px; left: 0; -webkit-appearance: none; appearance: none; background: transparent; pointer-events: all; z-index: 4; cursor: pointer;" 
                                   oninput="updatePriceRange(true)"
                                   onmousedown="startDragging('max')"
                                   onmouseup="stopDragging()"
                                   ontouchstart="startDragging('max')"
                                   ontouchend="stopDragging()" />
                            <!-- Price labels while dragging -->
                            <div id="priceMinLabel" style="display: none; position: absolute; top: -30px; background: #222; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; white-space: nowrap; transform: translateX(-50%); pointer-events: none; z-index: 6;"></div>
                            <div id="priceMaxLabel" style="display: none; position: absolute; top: -30px; background: #222; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; white-space: nowrap; transform: translateX(-50%); pointer-events: none; z-index: 6;"></div>
                        </div>
                    </div>
                    
                    <style>
                        /* Custom range input styling */
                        #priceMin::-webkit-slider-thumb,
                        #priceMax::-webkit-slider-thumb {
                            -webkit-appearance: none;
                            appearance: none;
                            width: 20px;
                            height: 20px;
                            background: white;
                            border: 2px solid #222;
                            border-radius: 50%;
                            cursor: pointer;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        }
                        
                        #priceMin::-moz-range-thumb,
                        #priceMax::-moz-range-thumb {
                            width: 20px;
                            height: 20px;
                            background: white;
                            border: 2px solid #222;
                            border-radius: 50%;
                            cursor: pointer;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        }
                        
                        #priceMin::-webkit-slider-thumb:hover,
                        #priceMax::-webkit-slider-thumb:hover {
                            transform: scale(1.1);
                        }
                    </style>
                    
                    <!-- Price Display -->
                    <div style="display: flex; justify-content: space-between; gap: 10px; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Minimum</label>
                            <input type="number" id="priceMinInput" value="0" min="0" max="500" step="10"
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
                                   onchange="updatePriceRangeFromInput()" />
                        </div>
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 5px;">Maximum</label>
                            <input type="number" id="priceMaxInput" value="500" min="0" max="500" step="10"
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
                                   onchange="updatePriceRangeFromInput()" />
                        </div>
                    </div>
                </div>

                <div class="filter-group">
                    <h4>Rating</h4>
                    <label class="checkbox-label">
                        <input type="checkbox" value="5" onchange="applyFilters()"> ‚≠ê 5 Stars
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="4" onchange="applyFilters()"> ‚≠ê 4+ Stars
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="3" onchange="applyFilters()"> ‚≠ê 3+ Stars
                    </label>
                </div>

                <div class="filter-group">
                    <h4>Availability</h4>
                    <label class="checkbox-label">
                        <input type="checkbox" value="today" onchange="applyFilters()"> Available Today
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="weekend" onchange="applyFilters()"> Weekend Available
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" value="verified" onchange="applyFilters()"> Verified Only
                    </label>
                </div>

                <button class="btn-clear-filters" onclick="clearFilters()">Clear All Filters</button>
            </div>

            <div class="providers-list" id="providersList">
                <!-- Providers will be loaded here dynamically -->
            </div>
        </div>
    </section>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Customer Login</h2>
            <form class="login-form" onsubmit="handleCustomerLogin(event)">
                <input type="email" placeholder="Email Address" required />
                <input type="password" placeholder="Password" required />
                <button type="submit" class="btn-submit">Login</button>
                <p class="form-footer">Don't have an account? <a href="#" onclick="showSignup()">Sign up</a></p>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>üéØ Task Masters</h3>
                <p>Your trusted service marketplace</p>
            </div>
            <div class="footer-section">
                <h4>Company</h4>
                <a href="index.html#about">About Us</a>
                <a href="#">Careers</a>
                <a href="#">Press</a>
            </div>
            <div class="footer-section">
                <h4>Support</h4>
                <a href="#">Help Center</a>
                <a href="#">Safety</a>
                <a href="#">Terms of Service</a>
            </div>
            <div class="footer-section">
                <h4>For Providers</h4>
                <a href="service-provider-login.html">Provider Login</a>
                <a href="service-provider-login.html">Become a Provider</a>
                <a href="#">Provider Resources</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 Task Masters. All rights reserved.</p>
        </div>
    </footer>

    <script src="services.js?v=20260125-004"></script>
    <script src="script.js"></script>
    <script>
        // Force verification that autocorrect variables exist
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üîç VERIFICATION - Autocorrect variables:');
            console.log('   - finalSearchQuery:', typeof finalSearchQuery !== 'undefined' ? finalSearchQuery : 'NOT DEFINED');
            console.log('   - userTypedQuery:', typeof userTypedQuery !== 'undefined' ? userTypedQuery : 'NOT DEFINED');
            console.log('   - wasAutoCorrected:', typeof wasAutoCorrected !== 'undefined' ? wasAutoCorrected : 'NOT DEFINED');
            
            // Update navigation based on login status
            const customerAuth = Auth.isLoggedIn('customer');
            const providerAuth = Auth.isLoggedIn('provider');
            
            const loginBtn = document.getElementById('loginBtn');
            const providerBtn = document.getElementById('providerBtn');
            
            if (loginBtn && providerBtn) {
                if (customerAuth) {
                    loginBtn.outerHTML = '<a href="customer-dashboard.html" class="btn-login" style="text-decoration: none; display: inline-block;">My Dashboard</a>';
                } else if (providerAuth) {
                    loginBtn.outerHTML = '<a href="provider.html" class="btn-login" style="text-decoration: none; display: inline-block;">My Dashboard</a>';
                    providerBtn.style.display = 'none';
                }
            }
        });

        // Mobile menu toggle
        function toggleMobileMenu() {
            const navLinks = document.getElementById('navLinks');
            const menuToggle = document.getElementById('mobileMenuToggle');
            navLinks.classList.toggle('active');
            menuToggle.classList.toggle('active');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const navLinks = document.getElementById('navLinks');
            const menuToggle = document.getElementById('mobileMenuToggle');
            const navbar = document.querySelector('.navbar');
            
            if (navLinks && menuToggle && navbar) {
                if (!navbar.contains(event.target) && navLinks.classList.contains('active')) {
                    navLinks.classList.remove('active');
                    menuToggle.classList.remove('active');
                }
            }
        });

        // Close mobile menu when clicking a link
        document.querySelectorAll('.nav-links a, .nav-links button').forEach(link => {
            link.addEventListener('click', function() {
                const navLinks = document.getElementById('navLinks');
                const menuToggle = document.getElementById('mobileMenuToggle');
                if (navLinks && menuToggle) {
                    navLinks.classList.remove('active');
                    menuToggle.classList.remove('active');
                }
            });
        });

        // Location change function
        function changeLocation() {
            // Show location update modal
            const currentLocation = LocationService.getLocation();
            const currentDisplay = currentLocation ? LocationService.formatLocation(currentLocation) : 'Not set';
            
            const postalCode = prompt(
                `Current location: ${currentDisplay}\n\nEnter your postal code to update your location:\n(e.g., V5H 2K7 for Burnaby, M5H 2N2 for Toronto)`,
                currentLocation && currentLocation.postalCode ? currentLocation.postalCode : ''
            );
            
            if (postalCode && postalCode.trim()) {
                const trimmedCode = postalCode.trim().toUpperCase().replace(/\s+/g, '');
                const formatted = trimmedCode.slice(0, 3) + ' ' + trimmedCode.slice(3);
                
                // Validate and set location
                if (LocationService.validatePostalCode(formatted)) {
                    LocationService.setLocationByPostalCode(formatted);
                    // Reload page to show updated location
                    window.location.reload();
                } else {
                    alert('Invalid postal code. Please check and try again.\n\nExamples:\n- V5H 2K7 (Burnaby, BC)\n- M5H 2N2 (Toronto, ON)\n- 98101 (Seattle, WA)');
                }
            }
        }

        // Price Range Slider Functionality
        let priceData = [
            { range: '$0-$50', count: 45 },
            { range: '$50-$100', count: 78 },
            { range: '$100-$150', count: 92 },
            { range: '$150-$200', count: 65 },
            { range: '$200-$250', count: 38 },
            { range: '$250-$300', count: 22 },
            { range: '$300-$350', count: 15 },
            { range: '$350-$400', count: 8 },
            { range: '$400-$450', count: 5 },
            { range: '$450-$500', count: 3 }
        ];

        function initPriceHistogram() {
            const histogram = document.getElementById('priceHistogram');
            if (!histogram) return;
            
            const maxCount = Math.max(...priceData.map(d => d.count));
            
            histogram.innerHTML = priceData.map((data, index) => {
                const heightPercent = (data.count / maxCount) * 100;
                const isInRange = isPriceRangeInSelection(index);
                
                return `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; cursor: pointer;"
                         onmouseover="showPriceTooltip(event, '${data.range}', ${data.count})"
                         onmouseout="hidePriceTooltip()">
                        <div style="width: 100%; background: ${isInRange ? '#222' : '#ddd'}; border-radius: 2px 2px 0 0; height: ${heightPercent}%; transition: all 0.3s;"></div>
                    </div>
                `;
            }).join('');
        }

        function isPriceRangeInSelection(index) {
            const minPrice = parseInt(document.getElementById('priceMinInput').value);
            const maxPrice = parseInt(document.getElementById('priceMaxInput').value);
            const rangeStart = index * 50;
            const rangeEnd = (index + 1) * 50;
            
            return !(rangeEnd < minPrice || rangeStart > maxPrice);
        }

        let tooltipTimeout;
        function showPriceTooltip(event, range, count) {
            clearTimeout(tooltipTimeout);
            
            let tooltip = document.getElementById('priceTooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'priceTooltip';
                tooltip.style.cssText = 'position: fixed; background: #333; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 10000; pointer-events: none; box-shadow: 0 2px 8px rgba(0,0,0,0.3);';
                document.body.appendChild(tooltip);
            }
            
            tooltip.innerHTML = `<strong>${range}</strong><br>${count} providers`;
            tooltip.style.display = 'block';
            tooltip.style.left = event.clientX + 10 + 'px';
            tooltip.style.top = event.clientY - 40 + 'px';
        }

        function hidePriceTooltip() {
            tooltipTimeout = setTimeout(() => {
                const tooltip = document.getElementById('priceTooltip');
                if (tooltip) tooltip.style.display = 'none';
            }, 100);
        }

        function updatePriceRange(isDragging = false) {
            const minSlider = document.getElementById('priceMin');
            const maxSlider = document.getElementById('priceMax');
            const minInput = document.getElementById('priceMinInput');
            const maxInput = document.getElementById('priceMaxInput');
            const track = document.getElementById('priceRangeTrack');
            const minLabel = document.getElementById('priceMinLabel');
            const maxLabel = document.getElementById('priceMaxLabel');
            
            let minVal = parseInt(minSlider.value);
            let maxVal = parseInt(maxSlider.value);
            
            // Ensure min doesn't exceed max
            if (minVal > maxVal - 20) {
                minVal = maxVal - 20;
                minSlider.value = minVal;
            }
            
            // Update inputs
            minInput.value = minVal;
            maxInput.value = maxVal;
            
            // Update visual track
            const percentMin = (minVal / 500) * 100;
            const percentMax = (maxVal / 500) * 100;
            
            track.style.left = percentMin + '%';
            track.style.right = (100 - percentMax) + '%';
            
            // Update labels while dragging
            if (isDragging) {
                minLabel.textContent = '$' + minVal;
                minLabel.style.left = percentMin + '%';
                
                maxLabel.textContent = '$' + maxVal;
                maxLabel.style.left = percentMax + '%';
            }
            
            // Update histogram
            initPriceHistogram();
            
            // Apply filters (debounced)
            clearTimeout(window.priceFilterTimeout);
            window.priceFilterTimeout = setTimeout(() => {
                applyFilters();
            }, 300);
        }

        let activeDragHandle = null;

        function startDragging(handle) {
            activeDragHandle = handle;
            const minLabel = document.getElementById('priceMinLabel');
            const maxLabel = document.getElementById('priceMaxLabel');
            
            if (handle === 'min') {
                minLabel.style.display = 'block';
            } else {
                maxLabel.style.display = 'block';
            }
            
            updatePriceRange(true);
        }

        function stopDragging() {
            const minLabel = document.getElementById('priceMinLabel');
            const maxLabel = document.getElementById('priceMaxLabel');
            
            minLabel.style.display = 'none';
            maxLabel.style.display = 'none';
            
            activeDragHandle = null;
        }

        function updatePriceRangeFromInput() {
            const minInput = document.getElementById('priceMinInput');
            const maxInput = document.getElementById('priceMaxInput');
            const minSlider = document.getElementById('priceMin');
            const maxSlider = document.getElementById('priceMax');
            
            let minVal = parseInt(minInput.value) || 0;
            let maxVal = parseInt(maxInput.value) || 500;
            
            // Clamp values
            minVal = Math.max(0, Math.min(minVal, 500));
            maxVal = Math.max(0, Math.min(maxVal, 500));
            
            // Ensure min doesn't exceed max
            if (minVal > maxVal - 10) {
                minVal = maxVal - 10;
                minInput.value = minVal;
            }
            
            minSlider.value = minVal;
            maxSlider.value = maxVal;
            
            updatePriceRange();
        }

        // Initialize price histogram on page load
        window.addEventListener('DOMContentLoaded', () => {
            initPriceHistogram();
            updatePriceRange();
        });
    </script>
</body>
</html>
